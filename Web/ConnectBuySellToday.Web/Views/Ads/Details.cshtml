@model ConnectBuySellToday.Application.DTOs.AdDto

@using ConnectBuySellToday.Domain.Enums
@using System.Security.Claims

@{
    ViewData["Title"] = Model.Title;
    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
}

<div class="container">
    <div class="row">
        <div class="col-md-6">
            @if (Model.ImageUrls.Any())
            {
                <div id="carouselExample" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        @for (int i = 0; i < Model.ImageUrls.Count; i++)
                        {
                            <div class="carousel-item @(i == 0 ? "active" : "")">
                                <img src="@Model.ImageUrls[i]" class="d-block w-100" alt="@Model.Title" style="height: 400px; object-fit: cover;">
                            </div>
                        }
                    </div>
                    @if (Model.ImageUrls.Count > 1)
                    {
                        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    }
                </div>
            }
            else if (!string.IsNullOrEmpty(Model.MainImageUrl))
            {
                <img src="@Model.MainImageUrl" class="img-fluid rounded" alt="@Model.Title" style="width: 100%;">
            }
            else
            {
                <div class="bg-secondary d-flex align-items-center justify-content-center rounded" style="height: 400px;">
                    <span class="text-white">No Image Available</span>
                </div>
            }
        </div>
        <div class="col-md-6">
            <h1>@Model.Title</h1>
            <h2 class="text-primary">$@Model.Price.ToString("N2")</h2>
            
            <div class="mb-3">
                <span class="badge bg-info">@Model.CategoryName</span>
                <span class="badge bg-@(Model.Status == AdStatus.Active ? "success" : "secondary")">
                    @Model.Status
                </span>
            </div>
            
            <div class="mb-3">
                <h5>Description</h5>
                <p>@Model.Description</p>
            </div>
            
            <div class="mb-3">
                <p class="text-muted"><small>Posted: @Model.CreatedAt.ToString("MMMM dd, yyyy HH:mm")</small></p>
                <p class="text-muted"><small>Seller ID: @Model.SellerId</small></p>
            </div>
            
            @if (User.Identity?.IsAuthenticated == true && currentUserId != Model.SellerId)
            {
                <a asp-controller="Dashboard" asp-action="Chat" asp-route-adId="@Model.Id" asp-route-otherUserId="@Model.SellerId" class="btn btn-success btn-lg">Contact Seller</a>
                <button class="btn btn-danger btn-lg" data-bs-toggle="modal" data-bs-target="#reportAdModal">Report Ad</button>
            }
            else if (currentUserId == Model.SellerId)
            {
                <span class="btn btn-secondary btn-lg disabled">Your Ad</span>
            }
            else
            {
                <a asp-area="Identity" asp-page="/Account/Login" asp-route-returnUrl="@Url.Action("Details", "Ads", new { id = Model.Id })" class="btn btn-success btn-lg">Login to Contact Seller</a>
            }
            <a asp-controller="Ads" asp-action="Index" class="btn btn-outline-secondary btn-lg">Back to List</a>
        </div>
    </div>
</div>

<!-- Report Ad Modal -->
@if (User.Identity?.IsAuthenticated == true && currentUserId != Model.SellerId)
{
    <div class="modal fade" id="reportAdModal" tabindex="-1" aria-labelledby="reportAdModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportAdModalLabel">Report Ad</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="reportAdForm">
                    <div class="modal-body">
                        <input type="hidden" id="AdId" name="AdId" value="@Model.Id" />
                        <div class="mb-3">
                            <label for="Reason" class="form-label">Reason for reporting</label>
                            <select class="form-select" id="Reason" name="Reason" required>
                                <option value="">Select a reason</option>
                                <option value="1">Spam</option>
                                <option value="2">Inappropriate</option>
                                <option value="3">Fraud</option>
                                <option value="4">Misleading</option>
                                <option value="5">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="Description" class="form-label">Description</label>
                            <textarea class="form-control" id="Description" name="Description" rows="4" required placeholder="Please provide more details about your report..."></textarea>
                        </div>
                        <div id="reportMessage" class="alert d-none" role="alert"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Submit Report</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        document.getElementById('reportAdForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                adId: document.getElementById('AdId').value,
                reason: parseInt(document.getElementById('Reason').value),
                description: document.getElementById('Description').value
            };
            
            const messageDiv = document.getElementById('reportMessage');
            const submitBtn = this.querySelector('button[type="submit"]');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            try {
                const response = await fetch('@Url.Action("ReportAd", "Ads")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                messageDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
                
                if (result.success) {
                    messageDiv.classList.add('alert-success');
                    messageDiv.textContent = result.message;
                    setTimeout(() => {
                        var modal = bootstrap.Modal.getInstance(document.getElementById('reportAdModal'));
                        modal.hide();
                    }, 1500);
                } else {
                    messageDiv.classList.add('alert-danger');
                    messageDiv.textContent = result.message;
                }
            } catch (error) {
                messageDiv.classList.remove('d-none');
                messageDiv.classList.add('alert-danger');
                messageDiv.textContent = 'An error occurred. Please try again.';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Report';
            }
        });
    </script>
}
